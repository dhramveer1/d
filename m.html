<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Damage Module Receipt</title>
  <style>
    :root{
      --bg:#f6f8fa; --card:#ffffff; --accent:#4863f8; --accent-2:#8b5cf6;
      --muted:#6b7280; --success:#059669; --danger:#dc2626; --radius:12px;
      --shadow: 0 8px 30px rgba(15,23,42,0.06);
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial; background:linear-gradient(180deg,#f1f6ff 0%,var(--bg) 100%); margin:0; padding:28px; color:#0f172a;}
    .container{max-width:980px;margin:0 auto;padding:6px;}
    .card{background:var(--card);border-radius:14px;padding:22px;box-shadow:var(--shadow);border:1px solid rgba(11,99,214,0.04);}
    .header{display:flex;gap:14px;align-items:center;}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:18px;}
    h1{margin:0;font-size:18px;} p.lead{margin:6px 0 0;color:var(--muted);font-size:13px;}
    label{font-size:13px;color:var(--accent);font-weight:700;display:block;margin-bottom:8px;}
    select,input,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e6e9ef;font-size:14px;background:#fff;}
    textarea{min-height:80px;resize:vertical;}
    .module-area{background:#fbfdff;border-radius:10px;padding:12px;border:1px solid #eef2ff;margin-top:14px;}
    .module-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
    .btn{padding:8px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:700;}
    .btn-add{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;}
    .btn-remove{background:#fff;border:1px solid #e5e7eb;}
    .row-item{display:flex;gap:10px;align-items:flex-start;padding:10px;border-radius:10px;background:white;border:1px solid #eef2ff;margin-top:8px;}
    .row-left{flex:1;} .row-mid{flex:1;}
    .icon-btn{width:38px;height:38px;border-radius:8px;border:0;background:#fff;display:inline-grid;place-items:center;cursor:pointer;box-shadow:0 6px 14px rgba(2,6,23,0.04);}
    .two-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
    @media(max-width:720px){.two-grid{grid-template-columns:1fr;}}
    .actions{display:flex;gap:12px;margin-top:18px;align-items:center;}
    .submit{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:white;padding:10px 16px;border-radius:10px;border:0;font-weight:700;}
    .reset{background:#fff;border:1px solid #e5e7eb;color:#374151;padding:9px 14px;border-radius:10px;font-weight:700;}
    .msg{margin-top:10px;font-size:14px;color:var(--muted);} .msg.error{color:var(--danger);} .msg.success{color:var(--success);}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="header">
        <div class="logo">DM</div>
        <div>
          <h1>Damage Module Receipt</h1>
          <p class="lead">Record broken/damaged PV modules received on site</p>
        </div>
      </div>

      <form id="damageForm">
        <!-- 1) Site Name ‚Äî dropdown (only allowed sites) -->
<div style="margin-top:18px;">
  <label>1) Site Name</label>
  <select id="pageSite">
    <option value="" disabled selected>Select site</option>
    <option value="MALSAR">MALSAR</option>
    <option value="TOLASAR">TOLASAR</option>
    <option value="BILLIYUBAS">BILLIYUBAS</option>
    <option value="SAWAR">SAWAR</option>
    <option value="GIRGHICHIYA">GIRGHICHIYA</option>
    <option value="BHOJASAR">BHOJASAR</option>
    <option value="SUMERIYA">SUMERIYA</option>
  </select>
</div>


        <div class="module-area">
          <div class="module-controls">
            <div style="font-weight:700;color:var(--accent)">2) Module serial numbers & reason (max 10 rows)</div>
            <div>
              <button type="button" id="addRowBtn" class="btn btn-add">+ Add row</button>
              <button type="button" id="removeLastBtn" class="btn btn-remove">‚àí Remove last</button>
            </div>
          </div>
          <div id="rowsList"></div>
        </div>

        <div style="margin-top:18px;">
          <label>3) Pallet No. (from which broken modules received)</label>
          <input type="text" id="palletNo" placeholder="e.g. PLT-2025-001">
        </div>

        <div style="margin-top:18px;">
          <label>4) Invoice / Delivery Challan No. (pallet)</label>
          <input type="text" id="invoiceNo" placeholder="e.g. INV-45987">
        </div>

        <div class="two-grid">
          <div>
            <label>5) Date of received modules</label>
            <input type="date" id="receivingDate">
          </div>
          <div>
            <label>Inspected by (site engineer)</label>
            <input type="text" id="engineer" placeholder="Site Engineer name">
          </div>
        </div>

        <div style="margin-top:18px;">
          <label>Additional notes (optional)</label>
          <textarea id="notes" placeholder="e.g. packaging damaged, photos attached, etc."></textarea>
        </div>

        <div class="actions">
          <button type="submit" class="submit">Submit to Sheet</button>
          <button type="button" id="resetBtn" class="reset">Reset</button>
        </div>

        <div id="message" class="msg"></div>
      </form>
    </div>
  </div>

  <script>
    // ---- UPDATE THIS to your deployed Apps Script web app URL if different ----
    const POST_URL = "https://script.google.com/macros/s/AKfycby9qPUk7Mf1DBNXUKjGRsQpu4dwNtpNBdpPdfI-aDU7pdftimmNZ6GJMvh9AMo5E1DbhQ/exec";

    // elements
    const pageSite = document.getElementById('pageSite');
    const rowsList = document.getElementById('rowsList');
    const addRowBtn = document.getElementById('addRowBtn');
    const removeLastBtn = document.getElementById('removeLastBtn');
    const palletNo = document.getElementById('palletNo');
    const invoiceNo = document.getElementById('invoiceNo');
    const receivingDate = document.getElementById('receivingDate');
    const engineer = document.getElementById('engineer');
    const notes = document.getElementById('notes');
    const messageEl = document.getElementById('message');
    const resetBtn = document.getElementById('resetBtn');
    const submitBtn = document.querySelector('.submit');

    function showMessage(txt, type='') {
      messageEl.textContent = txt;
      messageEl.className = 'msg ' + type;
    }

    function escapeHtml(str) {
      return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
    }

    function createRow(serial = '', damage = '') {
      const div = document.createElement('div');
      div.className = 'row-item';
      div.innerHTML = `
        <div class="row-left">
          <label style="font-size:12px;color:var(--muted)">Module Serial No.</label>
          <input type="text" class="input-serial" placeholder="MOD-12345" value="${escapeHtml(serial)}">
        </div>
        <div class="row-mid">
          <label style="font-size:12px;color:var(--muted)">Damage / Reason</label>
          <textarea class="input-damage" placeholder="Short description">${escapeHtml(damage)}</textarea>
        </div>
        <button type="button" class="icon-btn btn-remove" title="Remove row">üóëÔ∏è</button>
      `;
      const del = div.querySelector('.btn-remove');
      del.onclick = () => {
        div.remove();
        updateAddButtonState();
      };
      rowsList.appendChild(div);
      updateAddButtonState();
      div.querySelector('.input-serial').focus();
    }

    function updateAddButtonState() {
      addRowBtn.disabled = (rowsList.children.length >= 10);
      removeLastBtn.disabled = (rowsList.children.length === 0);
    }

    // add/remove handlers
    addRowBtn.onclick = () => {
      if (rowsList.children.length >= 10) { alert('Maximum 10 rows allowed.'); return; }
      createRow();
    };
    removeLastBtn.onclick = () => {
      const last = rowsList.lastElementChild;
      if (last) last.remove();
      updateAddButtonState();
    };

    // Reset: always clear everything and leave exactly 1 blank row
    function resetForm() {
      rowsList.innerHTML = '';
      createRow(); // 1 blank row
      palletNo.value = '';
      invoiceNo.value = '';
      receivingDate.value = '';
      engineer.value = '';
      pageSite.value = '';
      notes.value = '';
      showMessage('');
      updateAddButtonState();
    }

    resetBtn.onclick = () => {
      if (confirm('Clear all fields?')) resetForm();
    };

    // init UI with one blank row
    resetForm();

    // submit handler: sends one POST per row (keeps order matching Apps Script)
    document.getElementById('damageForm').onsubmit = async e => {
      e.preventDefault();

      const siteValue = pageSite.value.trim().toUpperCase();
      const rows = Array.from(rowsList.children).map(r => ({
        serial: r.querySelector('.input-serial').value.trim(),
        damage: r.querySelector('.input-damage').value.trim()
      })).filter(r => r.serial && r.damage);

      if (!rows.length) return showMessage('Please fill module serials & reasons.', 'error');
      if (!palletNo.value.trim()) return showMessage('Pallet No. required.', 'error');
      if (!receivingDate.value) return showMessage('Receiving Date required.', 'error');
      if (!engineer.value.trim()) return showMessage('Engineer name required.', 'error');
      if (!siteValue) return showMessage('Site name required.', 'error');

      submitBtn.disabled = true;
      submitBtn.style.opacity = '0.7';
      showMessage(`Submitting ${rows.length} row(s)...`);

      let success = 0;
      for (const r of rows) {
        const payload = {
          serial: r.serial,
          pallet: palletNo.value.trim(),
          damage: r.damage,
          receivingDate: receivingDate.value,
          engineer: engineer.value.trim(),
          site: siteValue,
          notes: notes.value.trim()
        };

        // debug: show what we're sending
        console.log('Sending payload:', payload);

        try {
          const res = await fetch(POST_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'},
            body: new URLSearchParams(payload).toString()
          });

          const text = await res.text();
          console.log('Server response (raw):', text);

          let data;
          try { data = JSON.parse(text); } catch { data = { raw: text }; }

          // if server returns success, increment
          if (data && data.status === 'success') success++;
          else console.warn('Server returned non-success for row:', data);
        } catch (err) {
          console.error('Fetch error:', err);
        }
      }

      submitBtn.disabled = false;
      submitBtn.style.opacity = '';
      showMessage(`‚úÖ ${success}/${rows.length} rows saved.`, 'success');

      if (success === rows.length) {
        setTimeout(() => {
          resetForm();
          showMessage('‚úÖ Data submitted successfully. Form cleared.', 'success');
        }, 900);
      } else {
        showMessage(`‚ö†Ô∏è ${success}/${rows.length} saved. Fix remaining and resubmit.`, 'error');
      }
    };
  </script>
</body>
</html>
